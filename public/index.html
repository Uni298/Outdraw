<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>人間 vs AI</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=DotGothic16&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Fullscreen toggle button style */
      #fullscreen-toggle {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 2000;
        padding: 6px 12px;
        font-size: 14px;
        cursor: pointer;
      }
      
      /* Row Filters */
      .row-filters-container {
        margin-bottom: 10px;
        overflow-x: auto;
      }
      .row-filters {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
      }
      .row-filter-btn {
        padding: 4px 8px;
        font-size: 12px;
        background: #eee;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        user-select: none;
      }
      .row-filter-btn:hover {
        background: #ddd;
      }
      .row-filter-btn.active {
        background: #4A90E2;
        color: white;
        border-color: #357ABD;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <!-- Lobby Screen -->
      <div id="lobby-screen" class="screen active">
        <div class="container">
          <h1 class="title">🎨 人間 vs AI</h1>
          <p class="subtitle">
            AIには分からないように、人間だけに伝わる絵を描こう!
          </p>

          <div class="card">
            <div class="input-group">
              <label for="player-name">プレイヤー名</label>
              <input
                type="text"
                id="player-name"
                placeholder="名前を入力"
                maxlength="20"
              />
            </div>

            <div class="button-group">
              <button id="create-room-btn" class="btn btn-primary">
                部屋を作成
              </button>
              <button id="join-room-btn" class="btn btn-secondary">
                部屋に参加
              </button>
            </div>

            <div id="join-room-input" class="input-group hidden">
              <label for="room-code">部屋コード</label>
              <input
                type="text"
                id="room-code"
                placeholder="6桁のコード"
                maxlength="6"
              />
              <button id="join-confirm-btn" class="btn btn-primary">
                参加する
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Room ID Display (Top Left) -->
      <div id="room-id-display-container" class="room-id-display" style="display: none;">
        <span>ルームID: </span>
        <span id="room-id-display-value" class="room-id-value"></span>
      </div>

      <!-- Room Screen -->
      <div id="room-screen" class="screen">
        <div class="container">
          <div class="room-header">
            <h2>
              部屋コード:
              <span id="room-code-display" class="code">------</span>
            </h2>
            <button id="leave-room-btn" class="btn btn-danger">退出</button>
          </div>

          <div class="room-content">
            <div class="card">
              <h3>プレイヤー (<span id="player-count">0</span>/6)</h3>
              <div id="player-list" class="player-list"></div>
            </div>

            <div class="card" id="settings-card">
              <h3>
                ゲーム設定
                <span id="host-only-badge" class="host-badge hidden"
                  >ホスト専用</span
                >
              </h3>
              <div class="settings-grid">
                <div class="setting-item">
                  <label for="drawing-time">描画時間 (秒)</label>
                  <input
                    type="number"
                    id="drawing-time"
                    min="30"
                    max="180"
                    value="90"
                  />
                </div>
                <div class="setting-item">
                  <label for="guessing-time">回答時間 (秒)</label>
                  <input
                    type="number"
                    id="guessing-time"
                    min="15"
                    max="60"
                    value="30"
                  />
                </div>
                <div class="setting-item">
                  <label for="ai-top-n">AI判定範囲 (トップN)</label>
                  <select id="ai-top-n">
                    <option value="1">1位のみ</option>
                    <option value="2">2位まで</option>
                    <option value="3" selected>3位まで</option>
                  </select>
                </div>
                <div class="setting-item">
                  <input
                    type="number"
                    id="max-rounds"
                    min="1"
                    max="12"
                    value="6"
                  />
                </div>
                <div class="setting-item">
                  <label for="active-category-count"
                    >モデル制限 (カテゴリ数)</label
                  >
                  <input
                    type="number"
                    id="active-category-count"
                    min="3"
                    max="345"
                    value="10"
                  />
                </div>
                <div class="setting-item">
                  <label for="max-players">最大プレイヤー数</label>
                  <input
                    type="number"
                    id="max-players"
                    min="2"
                    max="12"
                    value="8"
                  />
                </div>
                <div class="setting-item checkbox-item">
                  <label for="allow-clear-canvas">クリアボタンを許可</label>
                  <input type="checkbox" id="allow-clear-canvas" checked />
                </div>
                <div class="setting-item">
                  <label for="topic-choice-count">お題の選択肢数</label>
                  <input
                    type="number"
                    id="topic-choice-count"
                    min="1"
                    max="3"
                    value="3"
                  />
                </div>
                <div class="setting-item">
                  <label for="canvas-size">キャンバスサイズ</label>
                  <select id="canvas-size">
                    <option value="600x600">600 x 600</option>
                    <option value="800x600" selected>800 x 600</option>
                    <option value="1000x800">1000 x 800</option>
                  </select>
                </div>
                <div class="setting-item">
                  <label for="pen-thickness">ペンの太さ</label>
                  <input
                    type="number"
                    id="pen-thickness"
                    min="1"
                    max="50"
                    value="10"
                  />
                </div>
              </div>
              <button
                id="update-settings-btn"
                class="btn btn-secondary"
                style="display: none"
              >
                設定を更新
              </button>
            </div>
          </div>

          <button id="start-game-btn" class="btn btn-primary btn-large">
            ゲーム開始
          </button>
        </div>
      </div>

      <!-- Category Selection Screen -->
      <div id="category-screen" class="screen">
        <div class="container">
          <h2 class="phase-title">お題を選んでください</h2>
          <div id="category-choices" class="category-grid"></div>
          <div id="waiting-category" class="waiting hidden">
            <div class="spinner"></div>
            <p>描く人がお題を選んでいます...</p>
          </div>
        </div>
      </div>

      <!-- Drawing Screen -->
      <div id="drawing-screen" class="screen">
        <div class="container">
          <div class="game-header">
            <div class="round-info">
              ラウンド <span id="current-round">1</span>/<span
                id="max-rounds-display"
                >6</span
              >
            </div>
            <div class="timer" id="drawing-timer">90</div>
            <div class="category-display">
              お題: <span id="current-category">???</span>
            </div>
            <button id="end-game-btn-drawing" class="btn btn-secondary btn-small host-only hidden" style="margin-left: 10px;">中断</button>
          </div>

          <div class="drawing-area">
            <div class="canvas-container">
              <canvas id="drawing-canvas" width="800" height="600"></canvas>
            </div>

            <div class="sidebar">
              <div class="card">
                <h3>プレイヤー</h3>
                <div id="game-player-list" class="player-list-small"></div>
              </div>
              <div class="card">
                <h3>スコア</h3>
                <div id="score-list" class="score-list"></div>
              </div>

              <!-- Spectator Category Viewer -->
              <div class="card" id="spectator-category-card" style="display: none;">
                <h3>回答の候補</h3>
                <div class="row-filters-container">
                    <div id="spectator-row-filters" class="row-filters"></div>
                </div>
                <div class="input-group">
                  <input
                    type="text"
                    id="drawing-category-search"
                    placeholder="カテゴリを検索..."
                    autocomplete="off"
                  />
                  <div id="drawing-category-list" class="category-selector" style="height: 200px;">
                    <!-- Categories will be populated here -->
                  </div>
                </div>
              </div>
              
              <div
                class="canvas-tools"
                id="drawing-tools"
                style="display: none"
              >
                <button id="clear-canvas-btn" class="btn btn-secondary">
                  クリア
                </button>
                <button id="end-drawing-btn" class="btn btn-primary">
                  描画完了
                </button>
              </div>
              </div>
            </div>
          </div>

          <div id="spectator-message" class="spectator-message hidden">
            <p>🎨 <span id="drawer-name">プレイヤー</span> が描いています...</p>
          </div>
        </div>
      </div>

      <!-- Guessing Screen -->
      <div id="guessing-screen" class="screen">
        <div class="container">
          <div class="game-header">
            <div class="round-info">
              ラウンド <span id="guess-round">1</span>/<span
                id="guess-max-rounds"
                >6</span
              >
            </div>
            <div class="timer" id="guessing-timer">30</div>
            <button id="end-game-btn-guessing" class="btn btn-secondary btn-small host-only hidden" style="margin-left: auto;">中断</button>
          </div>

          <div class="guessing-area">
            <div class="canvas-container">
              <canvas id="guess-canvas" width="800" height="600"></canvas>
            </div>

            <div class="sidebar">
              <div class="card">
                <h3>この絵は何?</h3>
                <div class="row-filters-container">
                  <div id="guessing-row-filters" class="row-filters"></div>
                </div>
                <div class="input-group">
                  <input
                    type="text"
                    id="category-search"
                    placeholder="カテゴリを検索..."
                    autocomplete="off"
                  />
                  <div id="category-list" class="category-selector">
                    <!-- Categories will be populated here -->
                  </div>
                  <button
                    id="submit-guess-btn"
                    class="btn btn-primary"
                    disabled
                  >
                    回答する
                  </button>
                </div>
                <div id="guess-status" class="guess-status"></div>
                <div id="selected-category" class="selected-category hidden">
                  選択中: <span id="selected-category-name"></span>
                </div>
              </div>

              <div class="card">
                <h3>回答済みプレイヤー</h3>
                <div id="guessed-players" class="guessed-list"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Results Screen -->
      <div id="results-screen" class="screen">
        <div class="container">
          <div class="results-header-container">
            <div
              id="result-head-human"
              class="result-head-score human-score-box"
            >
              <span class="score-label">人間チーム</span>
              <span class="score-num">0点</span>
            </div>
            <h2 class="phase-title">ラウンド結果</h2>
            <div id="result-head-ai" class="result-head-score ai-score-box">
              <span class="score-label">AI</span>
              <span class="score-num">0点</span>
            </div>
          </div>

          <div class="results-content">
            <div class="winner-banner" id="winner-banner" style="opacity: 0">
              <div class="winner-icon">🏆</div>
              <div class="winner-text" id="winner-text">人間チームの勝利!</div>
            </div>

            <div id="correct-answer" class="correct-answer">正解: ---</div>

            <div class="results-grid">
              <div class="card">
                <h3>みんなの回答</h3>
                <div id="human-guesses" class="guess-results"></div>
              </div>

              <div class="card result-drawing-card">
                <h3>描かれた絵</h3>
                <div
                  id="result-drawing-container"
                  class="result-drawing-container"
                ></div>
              </div>

              <div class="card">
                <h3>AIの予想</h3>
                <div id="ai-predictions" class="ai-results"></div>
              </div>
            </div>
          </div>

          <button id="next-round-btn" class="btn btn-primary btn-large">
            次のラウンド
          </button>
          <div id="waiting-next" class="waiting hidden">
            <p>ホストが次のラウンドを開始するのを待っています...</p>
          </div>
        </div>
      </div>

      <!-- Finished Screen -->
      <div id="finished-screen" class="screen">
        <div class="container">
          <h1 class="title">🎉 ゲーム終了!</h1>

          <div class="card">
            <h3>最終スコア</h3>
            <div id="final-score-list" class="score-list-large"></div>
          </div>

          <button id="return-lobby-btn" class="btn btn-primary btn-large">
            ロビーに戻る
          </button>
        </div>
      </div>
    </div>

    <!-- Reaction Display -->
    <div class="reaction-display" id="reactionDisplay"></div>

    <!-- Transition Overlay -->
    <div id="transition-overlay" class="transition-overlay">
      <div id="confidence-display" class="confidence-display">
        <div class="confidence-label">AI確信度</div>
        <div class="confidence-value"><span id="confidence-number">0</span>%</div>
      </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal">
      <div class="modal-content">
        <div class="modal-title" id="modalTitle">確認</div>
        <div class="modal-message" id="modalMessage">実行しますか?</div>
        <div class="modal-buttons">
          <button class="btn btn-secondary" id="modalCancel">キャンセル</button>
          <button class="btn btn-primary" id="modalConfirm">OK</button>
        </div>
      </div>
    </div>

    <!-- Floating Reaction Buttons (Left of Chat) -->
    <div id="floating-reaction-bar" class="floating-reaction-bar" style="display: none;">
      <button class="reaction-btn" data-emoji="good">
        <img src="/images/good.png" alt="Good" style="width: 24px; height: 24px" />
      </button>
    </div>

    <!-- Chat Box -->
    <div id="chatBox" class="minimized">
      <div id="chatHeader">
        <div class="chat-header-content">
          <button id="chatToggle">▲</button>
          <span id="chatNotification" class="notification-badge hidden"></span>
        </div>
      </div>
      <div id="chatMessages"></div>
      <!-- chat-preview removed -->
      <div id="chatInputArea">
        <input type="text" id="chatInput" placeholder="メッセージを入力..." />
        <button id="chatSendBtn">送信</button>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/translations.js"></script>
    <script src="/js/category_readings.js"></script>
    <script src="/js/canvas.js"></script>
    <script src="/js/ui.js"></script>
    <script src="/js/client.js"></script>
    <script src="/js/chat.js"></script>
  </body>
</html>
